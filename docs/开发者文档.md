# 程序员/开发者文档

iPelago 群岛是一个真正人人平等的地方，从最根本的设计上就决定了在这里没有任何人拥有特权。但如果没有人参与进来，再好的制度也只能是一片荒漠，而相关的软件对促进普通用户的参与起到至关重要的作用。**Keep it simple** 是 iPelago 软件设计的第一原则，因此，其设计及代码都非常简单，**只要略懂编程**的人都可以参与 iPelago 群岛的建设。

## 词汇

为了叙述方便，以下词语在本文中有以下定义：

- 为了方便大家参与 iPelago 群岛的建设，我虽然水平有限，也做了一个简陋的客户端，可以订阅别人的小岛，也可以发布自己的 newsletter ，这个客户端在本文中称为 **iPelago beta**
- 只订阅别人的小岛，自己不建岛不发布消息的人统称为**漂流族**
- 建岛并发布消息的人称为**岛主**

## 小岛地址与 Newsletter

- 岛主通过小岛地址对外发布消息，任何人向 iPelago beta 中添加一个小岛地址即可订阅小岛，并且可非常方便地批量订阅多个小岛。
- 小岛地址可以是一个静态文件的网址，也可以是一个 api 接口，只要能返回一个包含特定内容的 JSON 文件 (在本文中称为 **newsletter**) 即可。
- newsletter 的字符编码规定为 UTF-8
- newsletter 的体积上限为 15KB

**newsletter**(JSON 文件) 应包含以下内容 (使用 iPelago beta 可轻松生成 newsletter ):

```
{
  name: "某某的小岛",
  email: "user@example.com",
  avatar: "https://example.com/avatar.jpg",
  link: "https://example.com/ipelago.html",
  messages: [
    {
      time: 1623209466,
      body: "今天天气很好"
    },
    {
      time: 1623209000,
      body: "我发现有个游戏很好玩"
    }
  ]
}
```

- **name**: 岛名，相当于用户名或昵称（必填）
- **email**: 岛主的真实电子邮件，可作为后备联系方式。(可留空, 但建议填写)
- **avatar**: 头像图片的网址，头像图片应为正方形，建议头像体积控制在 50KB 以下。请确保头像图片能跨域访问。（可留空）
- **link**: 一个网址，可以是岛主的博客，也可以是小岛的网页版，也可以是岛主的其他社交帐号地址。（可留空）
- **messages**: 多条消息，必须按发布日期倒序排列（最新的排在最前）。必填，至少必须包含一条信息。
  - **time**: (必填) 发布时间，一个普通的时间戳, 精确到秒 (不包括毫秒), 不需要管时区问题。
  - **body**: (必填) 消息的正文，建议尽量简短，如果需要表达的内容较多，可添加链接，引导读者去网站看全文。

## 体积限制

- **Newsletter**(JSON 文件) 的体积上限为 15KB.
- 尽可能简化、尽可能节约资源是 iPelago 群岛的重要设计思想之一，因此请务必遵守该限制. 如果 iPelago 客户端接收 newsletter 时发现其体积超过 15KB, 应当作无效或格式错误来处理。
- 而且，每次检查一个小岛有没有新消息时，都需要下载整个 newsletter, 这也是 newsletter 需要保持小体积的重要原因之一。
- 由于 newsletter 有体积限制，不可能包含无限多的消息，因此在 **messages** 里只包含最近的消息，旧消息被滚动删除。(旧消息可保存在客户端的数据库中，包括发出的消息及接收到的消息都可以保存在客户端中。)
- 为了编程方便，建议每次发布 newsletter 时按照 "**messages** 里的全部 **body** 加起来总体积不超过 10KB" 的原则来处理，这样生成 newsletter 一般不会超过 15KB, 更详细的处理方法请参考 iPelago beta 源码。
- 建议在发布消息时，每条消息的 **body** 限制为 1KB 以下（只是建议，这个不强制，作为一种实现方法的参考，在 iPelago beta 里有此限制）。但要注意，接收消息时只限制整个 newsletter 的体积(15KB), 不可限制每条消息的 **body** 体积。
- 由于建岛很可能使用各种平台的免费服务，理应尽量节约资源，因此请务必遵守该限制。

## 时区

- 在 iPelago 群岛里没有时区，建议以北京时间为准生成时间戳，但不强制。
- 这样做有两个原因：
  1. 处理时区问题很烦，也容易出错。
  2. 强调慢沟通，强调发布消息不具备即时性，并且希望用户不要频繁刷新，一般一天刷新一次即可，既减轻焦虑，也节省公共资源。
- 为了避免恶意输入错误的时间，在接收 `newsletter` 时应验证 `messages` 里的 `time`, 如果超过 "当前时间 + 24小时" (因为不同时区的最大差异是 24 小时), 应忽略该消息。更详细的处理方法请参考 iPelago beta 源码。
- 建议在批量刷新时判断每个岛上次获取消息的时间，如果在 24 小时以内则自动忽略（这个不强制要求，作为一种实现方法的参考，在 iPelago beta 里采用这种处理方法）。另外可给每个岛加一个刷新按钮，不受时间限制强制刷新一个岛的消息。
